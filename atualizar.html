<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atualizar Lotes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f7f7f7;
}
h2 { margin-bottom: 10px; }
table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  font-size: 19px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
  text-align: center;
}
th { background: #f0f0f0; }
tr.vendido { background-color: #ffd6d6; }
tr.livre { background-color: #d6ffd6; }
input[type="number"] {
  width: 110px;
  padding: 4px;
  font-size: 18px;
}
select { padding: 4px; font-size: 18px; }
button {
  margin-top: 15px;
  padding: 10px 20px;
  font-size: 14px;
  cursor: pointer;
}
.filtro-container {
  margin-bottom: 10px;
}
.filtro-container input, .filtro-container select {
  margin-right: 5px;
}
</style>
</head>

<body>

<h2>Atualiza√ß√£o de Lotes</h2>

<div class="filtro-container">
  <!-- Filtro por quadra -->
  <input type="text" id="filtroQuadra" placeholder="Filtrar por quadra...">

  <!-- Corre√ß√£o de valores -->
  <input type="number" id="valorCorrecao" placeholder="Valor ou %" style="width:100px;">
  <select id="tipoCorrecao">
    <option value="valor">Valor fixo</option>
    <option value="percentual">Percentual (%)</option>
  </select>
  <button id="aplicarCorrecao">Aplicar Corre√ß√£o</button>
</div>

<table id="tabela">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>√Årea</th>
      <th>Valor</th>
      <th>Vendido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="salvar()">üíæ Salvar no Servidor</button>

<script>
const API_BASE = "https://backend-parque-riogrande.onrender.com";

let lotes = [];
let filtroQuadraValue = "";

// üîπ CARREGAR LOTES DO RENDER
async function carregarLotes() {
  try {
    const res = await fetch(`${API_BASE}/lotes`);
    if (!res.ok) throw new Error();

    const data = await res.json();

    // normaliza
    lotes = data.map(l => ({
      ...l,
      Valor: Number(l.Valor),
      Vendido: l.Vendido === true || l.Vendido === "TRUE",
      Quadra: l.Quadra || "" // caso n√£o exista
    }));

    montarTabela();
  } catch {
    alert("‚ùå Erro ao carregar dados do servidor");
  }
}

// üîπ MONTA TABELA
function montarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  lotes.forEach((lote, index) => {
    // Filtra pelo valor do campo filtro
    if (lote.Quadra.toUpperCase().includes(filtroQuadraValue.toUpperCase())) {
      const tr = document.createElement("tr");
      tr.className = lote.Vendido ? "vendido" : "livre";

      tr.innerHTML = `
        <td>${lote.ID}</td>
        <td>${lote.Nome}</td>
        <td>${lote.Area}</td>
        <td>
          <input
            type="number"
            value="${lote.Valor.toFixed(2)}"
            onchange="alterarValor(${index}, this.value)"
          >
        </td>
        <td>
          <select onchange="alterarVendido(${index}, this.value)">
            <option value="false" ${!lote.Vendido ? "selected" : ""}>Dispon√≠vel</option>
            <option value="true" ${lote.Vendido ? "selected" : ""}>Vendido</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// üîπ ALTERA VALOR
function alterarValor(index, novoValor) {
  lotes[index].Valor = Number(novoValor);
}

// üîπ ALTERA STATUS
function alterarVendido(index, valor) {
  lotes[index].Vendido = valor === "true";
  montarTabela();
}

// üîπ SALVA NO BACKEND (Render)
async function salvar() {
  try {
    for (const lote of lotes) {
      const response = await fetch(`${API_BASE}/lotes/${lote.ID}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(lote)
      });

      if (!response.ok) {
        throw new Error("Erro ao salvar lote " + lote.ID);
      }
    }

    alert("‚úÖ Dados salvos com sucesso!");

  } catch (err) {
    console.error(err);
    alert("‚ùå Erro ao salvar os dados");
  }
}

// üîπ FILTRO POR QUADRA
document.getElementById("filtroQuadra").addEventListener("input", (e) => {
  filtroQuadraValue = e.target.value;
  montarTabela();
});

// üîπ APLICAR CORRE√á√ÉO AUTOM√ÅTICA
document.getElementById("aplicarCorrecao").addEventListener("click", () => {
  const valorCorrecao = parseFloat(document.getElementById("valorCorrecao").value);
  const tipo = document.getElementById("tipoCorrecao").value;

  if (isNaN(valorCorrecao)) {
    alert("Digite um valor v√°lido para corre√ß√£o");
    return;
  }

  lotes.forEach((lote, index) => {
    if (lote.Quadra.toUpperCase().includes(filtroQuadraValue.toUpperCase())) {
      if (tipo === "valor") {
        lote.Valor += valorCorrecao;
      } else if (tipo === "percentual") {
        lote.Valor += lote.Valor * (valorCorrecao / 100);
      }
    }
  });

  montarTabela();
});

// üîπ INICIALIZA
document.addEventListener("DOMContentLoaded", carregarLotes);
</script>

</body>
</html>














