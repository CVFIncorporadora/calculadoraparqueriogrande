<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Atualizar Lotes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: 'Arial', sans-serif;
  padding: 20px;
  background: #f7f7f7;
}

h2 { 
  text-align: center;
  margin-bottom: 10px; 
  font-size: xx-large;
}
.table-wrapper {
  max-height: 1000px;          /* Altura m√°xima da tabela */
  overflow-y: auto;           /* Habilita rolagem vertical */
  border: 1px solid #ddd;     /* Borda ao redor da tabela */
  border-radius: 8px;
}

table {
  border-collapse: collapse;
  width: 100%;
  background: #fff;
  font-size: 19px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);

}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}

th { 
  background: #f0f0f0; 
  font-weight: 600;
}

tr.vendido { 
  background-color: #ffd6d6; 
}

tr.livre { 
  background-color: #d6ffd6; 
}
thead{
    position: sticky;           /* Deixa o cabe√ßalho fixo */
  top: 0;
  background: #f0f0f0;
  z-index: 1;                 /* Garante que fique acima das linhas */
}

/* Campos de entrada e selects padronizados e modernos */
input[type="text"],
input[type="number"],
select {
  font-size: 16px;           /* Fonte uniforme e mais moderna */
  height: 40px;              /* Altura consistente */
  padding: 6px 12px;         /* Espa√ßamento interno */
  border-radius: 8px;        /* Bordas arredondadas */
  border: 1px solid #ccc;    /* Borda suave */
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Leve sombra interna */
  box-sizing: border-box;    /* Inclui padding na altura */
  outline: none;             /* Remove contorno padr√£o */
  transition: 0.2s all ease; /* Suaviza hover e foco */
}

input[type="text"]:focus,
input[type="number"]:focus,
select:focus {
  border-color: #4a90e2;     /* Borda azul no foco */
  box-shadow: 0 0 5px rgba(74,144,226,0.3);
}

/* Campos dentro de filtro-container */
.filtro-container input,
.filtro-container select {
  margin-right: 10px;        /* Espa√ßamento entre campos */
  vertical-align: middle;    /* Alinha perfeitamente */
}

/* Bot√£o moderno */
button {
  margin-top: 15px;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background-color: #4a90e2;
  color: #fff;
  cursor: pointer;
  transition: 0.2s all ease;
}

button:hover {
  background-color: #357ab8;
}

/* Filtro container */
.filtro-container {
  margin-bottom: 10px;
}

</style>
</head>

<body>

<h2>Atualiza√ß√£o de Lotes</h2>

<div class="filtro-container">
  <!-- Filtro por empreendimento -->
  <select id="filtroEmpreendimento">
    <option value="">Todos os empreendimentos</option>
    <option value="01">Parque Rio Grande I</option>
    <option value="02">Parque Rio Grande II</option>
  </select>

  <!-- Filtro por letra da Quadra -->
  <input type="text" id="filtroQuadra" placeholder="Digite a letra da Quadra..." maxlength="1" >
  
  <!-- Filtro por n√∫mero do Lote -->
  <input type="number" id="filtroLote" placeholder="Digite o n√∫mero do Lote..." >

  <!-- Corre√ß√£o de valores -->
  <input type="number" id="valorCorrecao" placeholder="Valor ou %" >
  <select id="tipoCorrecao" >
    <option value="valor">Valor fixo</option>
    <option value="percentual">Percentual (%)</option>
  </select>
  <button id="aplicarCorrecao">Aplicar Corre√ß√£o</button>
  <button onclick="salvar()">üíæ Salvar Altera√ß√µes </style></button>
</div>
<div class="table-wrapper">
<table id="tabela">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>√Årea</th>
      <th>Valor</th>
      <th>Vendido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
const API_BASE = "https://backend-parque-riogrande.onrender.com";

let lotes = [];
let filtroEmpreendimentoValue = "";
let filtroQuadraValue = "";
let filtroLoteValue = "";

// üîπ CARREGAR LOTES DO RENDER
async function carregarLotes() {
  try {
    const res = await fetch(`${API_BASE}/lotes`);
    if (!res.ok) throw new Error();

    const data = await res.json();

    lotes = data.map(l => ({
      ...l,
      Valor: Number(l.Valor),
      Vendido: l.Vendido === true || l.Vendido === "TRUE",
      Nome: l.Nome || ""
    }));

    montarTabela();
  } catch {
    alert("‚ùå Erro ao carregar dados do servidor");
  }
}

// üîπ MONTA TABELA
function montarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  lotes.forEach((lote, index) => {
    const nomeUpper = lote.Nome.toUpperCase();

    // Filtrar por empreendimento
    const passaEmpreendimento = filtroEmpreendimentoValue === "" || nomeUpper.startsWith(filtroEmpreendimentoValue + "-");

    // Extrai letra da quadra
    const matchQuadra = nomeUpper.match(/QUADRA\s+([A-Z])/);
    const letraQuadra = matchQuadra ? matchQuadra[1] : "";
    const passaQuadra = filtroQuadraValue === "" || letraQuadra === filtroQuadraValue.toUpperCase();

    // Extrai n√∫mero do lote
    const matchLote = nomeUpper.match(/LOTE\s+(\d+)/);
    const numeroLote = matchLote ? matchLote[1] : "";
    const passaLote = filtroLoteValue === "" || numeroLote.includes(filtroLoteValue);

    // S√≥ exibe se passar todos os filtros
    if (passaEmpreendimento && passaQuadra && passaLote) {
      const tr = document.createElement("tr");
      tr.className = lote.Vendido ? "vendido" : "livre";

      tr.innerHTML = `
        <td>${lote.ID}</td>
        <td>${lote.Nome}</td>
        <td>${lote.Area}</td>
        <td>
          <input
            type="number"
            value="${lote.Valor.toFixed(2)}"
            onchange="alterarValor(${index}, this.value)"
          >
        </td>
        <td>
          <select onchange="alterarVendido(${index}, this.value)">
            <option value="false" ${!lote.Vendido ? "selected" : ""}>Dispon√≠vel</option>
            <option value="true" ${lote.Vendido ? "selected" : ""}>Vendido</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
    }
  });
}

// üîπ ALTERA VALOR
function alterarValor(index, novoValor) {
  lotes[index].Valor = Number(novoValor);
}

// üîπ ALTERA STATUS
function alterarVendido(index, valor) {
  lotes[index].Vendido = valor === "true";
  montarTabela();
}

// üîπ SALVA NO BACKEND (Render)
async function salvar() {
  try {
    for (const lote of lotes) {
      const response = await fetch(`${API_BASE}/lotes/${lote.ID}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lote)
      });

      if (!response.ok) {
        throw new Error("Erro ao salvar lote " + lote.ID);
      }
    }

    alert("‚úÖ Dados salvos com sucesso!");
  } catch (err) {
    console.error(err);
    alert("‚ùå Erro ao salvar os dados");
  }
}

// üîπ EVENTOS DOS FILTROS
document.getElementById("filtroEmpreendimento").addEventListener("change", (e) => {
  filtroEmpreendimentoValue = e.target.value;
  montarTabela();
});
document.getElementById("filtroQuadra").addEventListener("input", (e) => {
  filtroQuadraValue = e.target.value;
  montarTabela();
});
document.getElementById("filtroLote").addEventListener("input", (e) => {
  filtroLoteValue = e.target.value;
  montarTabela();
});

// üîπ APLICAR CORRE√á√ÉO AUTOM√ÅTICA
document.getElementById("aplicarCorrecao").addEventListener("click", () => {
  const valorCorrecao = parseFloat(document.getElementById("valorCorrecao").value);
  const tipo = document.getElementById("tipoCorrecao").value;

  if (isNaN(valorCorrecao)) {
    alert("Digite um valor v√°lido para corre√ß√£o");
    return;
  }

  lotes.forEach((lote, index) => {
    const nomeUpper = lote.Nome.toUpperCase();

    const passaEmpreendimento = filtroEmpreendimentoValue === "" || nomeUpper.startsWith(filtroEmpreendimentoValue + "-");
    const matchQuadra = nomeUpper.match(/QUADRA\s+([A-Z])/);
    const letraQuadra = matchQuadra ? matchQuadra[1] : "";
    const passaQuadra = filtroQuadraValue === "" || letraQuadra === filtroQuadraValue.toUpperCase();
    const matchLote = nomeUpper.match(/LOTE\s+(\d+)/);
    const numeroLote = matchLote ? matchLote[1] : "";
    const passaLote = filtroLoteValue === "" || numeroLote.includes(filtroLoteValue);

    if (passaEmpreendimento && passaQuadra && passaLote) {
      if (tipo === "valor") {
        lote.Valor += valorCorrecao;
      } else if (tipo === "percentual") {
        lote.Valor += lote.Valor * (valorCorrecao / 100);
      }
    }
  });

  montarTabela();
});

// üîπ INICIALIZA
document.addEventListener("DOMContentLoaded", carregarLotes);
</script>

</body>
</html>




















